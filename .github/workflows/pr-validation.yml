name: PR Validation

on:
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build CI Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.ci
        target: test
        tags: sigeco-ci:${{ matrix.node-version }}
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Run validation inside Docker container
      run: |
        docker run --rm \
          -e CI=true \
          sigeco-ci:${{ matrix.node-version }} \
          npm run validate
    
    - name: Check build size
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/dist:/app/dist:rw \
          sigeco-ci:${{ matrix.node-version }} \
          sh -c "echo 'Build completed successfully' && du -sh dist/ && echo 'Build artifacts:' && ls -lh dist/"
    
  console-validation-reminder:
    runs-on: ubuntu-latest
    
    steps:
    - name: Console Validation Reminder
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ‚ö†Ô∏è Lembrete: Valida√ß√£o do Console

            Antes de fazer merge deste PR, certifique-se de:

            ### ‚úÖ Checklist de Valida√ß√£o Manual

            - [ ] Executar \`npm run dev\` localmente
            - [ ] Abrir DevTools (F12) e verificar aba Console
            - [ ] Verificar que n√£o h√° erros cr√≠ticos (vermelho)
            - [ ] Verificar que n√£o h√° warnings de CORS
            - [ ] Navegar por todas as p√°ginas afetadas
            - [ ] Testar a funcionalidade implementada
            - [ ] Verificar que Error Boundaries funcionam (se aplic√°vel)

            ### üìã Definition of Done

            Consulte [CONTRIBUTING.md](../blob/main/CONTRIBUTING.md) para o checklist completo.

            **Erros N√ÉO aceit√°veis:**
            - ‚ùå Erros de CORS
            - ‚ùå Erros de React (incluindo #418)
            - ‚ùå Erros JavaScript n√£o tratados
            - ‚ùå Erros de recursos n√£o encontrados (404)

            ---
            *Esta valida√ß√£o √© cr√≠tica para manter a estabilidade do sistema.*`
          })
